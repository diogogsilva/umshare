extends layout

block content
  button.w3-btn.w3-round-large(onclick="window.location.href = '/register'") Registar utilizador
  button.w3-btn.w3-round-large(onclick="window.location.href = '/logout'") Logout
  style.
    body,h1,h2,h3,h4,h5 {font-family: "Raleway", sans-serif}
  .w3-content(style='max-width:1400px')
    div.alert.w3-red(id="divAlertWarning" style="opacity:0")
      span.closebtn &times;
      strong(id="msgWarning")
    div.alert.success(id="divAlertSuccess" style="opacity:0")
      span.closebtn &times;
      strong(id="msgSuccess")
    header.w3-container.w3-center.w3-padding-32
      h1
        b UM SHARE
      p
        | Welcome to the blog of 
        span.w3-tag unknown
    .w3-row
      .topnav
        a.active(id="tabFeed") Feed
        a(id="tabGrupos") Grupos
        a(id="tabPerfil") Perfil
        .search-container
          form(action='/action_page.php')
            input(type='text' placeholder='Search..' name='search')
            button(type='submit')
              i.fa.fa-search
    div(id="publicacoesLayout")
      div(id="divPublicacaoForm")
        form(action="http://localhost:5003/publicacoes" method="POST" enctype='multipart/form-data' id="publicacaoForm").w3-container.w3-center.w3-padding-16.w3-border
          h4.w3-left Publicação
          input.w3-input.w3-cell.w3-border.w3-margin-bottom(type="text" name="metadata" placeholder="Metadata? (Exemplo: SSI,TESTE)")
          input.w3-input.w3-cell.w3-border.w3-margin-bottom(id="conteudo" type="text" name="conteudo" placeholder="Texto" required)
          input.w3-input.w3-cell.w3-border.w3-margin-bottom.w3-hide(type="text" name="utilizador" value=user required)
          input.w3-input.w3-cell.w3-border.w3-margin-bottom.w3-hide(type="text" name="grupo" value='')        
          .w3-cell-row(id="f1")
            input.w3-input.w3-cell(type="file" id="ficheiro" name="ficheiro")
          button.w3-button.w3-round-large.w3-indigo.w3-left.w3-margin-bottom.w3-margin-top(id='addfile') Adicionar outro ficheiro
          input.w3-input.w3-hover-shadow.w3-center(type="submit" value="Publicar" id="btnPublicar")
      button.w3-button.w3-hover-shadow.w3-large.w3-grey(id='hidePublicacaoForm' style="width:100%") Esconder
      button.w3-button.w3-hover-shadow.w3-large.w3-grey.w3-hide(id='showPublicacaoForm' style="width:100%") Mostrar
      div(id="publicacoesInsertZone")

    div(id="gruposLayout")
      div(id="gruposInsertZone")
    
    div(id="grupoLayout" style="display:none")
      button.w3-button.w3-round-medium.w3-indigo.w3-left.w3-margin-left.w3-margin-top(id='backToGruposList') Voltar
      .w3-row
        .w3-col.l3
          .w3-card.w3-margin
            .w3-container.w3-padding.w3-dark-grey
              h4(id="nomeGrupo")
            .w3-container.w3-white
              h6(id="adminGrupo")
              p(id="descricaoGrupo")
            .w3-container.w3-blue
              h5 Membros
            div.w3-container.w3-white(id="listaMembrosGrupo")
          div(id="adminTools" style="display:none")
            .w3-card.w3-margin
              .w3-container.w3-padding.w3-dark-grey
                h5 Adicionar Membros
              .w3-container.w3-blue
                h5 Membros
              .w3-container.w3-white
                form(action="/addMembro" method="POST" id="formAddMembro")
                  input.w3-input.w3-border.w3-hover-border-black(type='email' name="idMembro" placeholder='Email...' required)
                  input.w3-input.w3-cell.w3-border.gid(type="hidden" name="gid" value="" required)
                  input.w3-button.w3-round-medium.w3-indigo(type="submit" value="Confirmar" style="width:100%")
            .w3-card.w3-margin
              .w3-container.w3-padding.w3-dark-grey
                h5 Remover Membros
              .w3-container.w3-blue
                h5 Membros
              .w3-container.w3-white
                form(action="/removeMembro" method="POST" id="formRemoveMembro")
                  input.w3-input.w3-border.w3-hover-border-black(type='email' name="idMembro" placeholder='Email...' required)
                  input.w3-input.w3-cell.w3-border.gid(type="hidden" name="gid" value="" required)
                  input.w3-button.w3-round-medium.w3-indigo(type="submit" value="Confirmar" style="width:100%")
        .w3-col.l9(id="grupoInsertZone")

    div(id="perfilLayout")
      div(id="perfilInsertZone")


  footer.w3-container.w3-dark-grey.w3-padding-32.w3-margin-top
    p
      | DWEB 2019/2020 
      a(href='https://github.com/diogogsilva/umshare' target='_blank') GitHub


      .w3-row(id="templatePublicacoes" style="display:none")
        .w3-col.l8.s12(id="idk")
          .w3-card-4.w3-margin.w3-white(id="t")

        
      .w3-card-4.w3-padding.w3-margin-bottom(id="pub" style="display:none")
        button.w3-right.w3-margin-top(id="removePublicacaoBtn") X
        h5
          p(id="metadataPub")
        h3
          p(id="conteudoPub")
        h5
          p(id="dataPub")
        h5
          p.w3-hide(id="idPub")

      .w3-container.w3-border.w3-border-black.w3-white.w3-margin.w3-margin-bottom(id="templateComentarios" style="display:none")
        button.w3-right.w3-margin-top(id="apagaComentarioBtn") X
        h5
          p(id="utilizadorCom")
        h4
          p(id="conteudoCom")
        h5
          p.w3-right(id="dataCom")
        h5.w3-hide(id="idCom")
        h5.w3-hide(id="idPub")

    div.w3-margin-bottom(id="divComentarioForm" style="display:none")
      form.w3-container.w3-borders.w3-border-indigo.w3-margin-top(action="/comentar" method="POST" id="comentarioForm")
        input.w3-input.w3-cell.w3-border.w3-hide(type="text" name="pubid" id="pubidForm")
        input.w3-input.w3-cell.w3-border(type="text" name="conteudo" placeholder="Escreva aqui o seu comentário" required)
        input.w3-input.w3-margin-top.w3-margin-bottom.w3-indigo(type="submit" value="Comentar")
      button.w3-button.w3-hover-shadow.w3-large.w3-grey(id='hideComentarioForm' style="width:100%") Esconder
      button.w3-button.w3-hover-shadow.w3-large.w3-grey.w3-hide(id='showComentarioForm' style="width:100%") Mostrar


      .w3-row(id="templateGrupos" style="display:none")
        .w3-col.l8.s12
          .w3-card-4.w3-margin.w3-white.grupo-container
            .w3-container
              h3
                p(id="nomeGrupo")
              h5
                p(id="descricaoGrupo")
              h5
                p(id="adminGrupo")
              h5
                p(id="membrosGrupo")

      .w3-row(id="templateGrupoPub" style="display:none")
        .w3-card-4.w3-margin.w3-white
          .w3-container
            h3
              p(id="conteudoPub")
            h5
              p(id="metadataPub")

      .w3-row(id="templatePerfil" style="display:none")
        .w3-col.l8.s12
          .w3-card-4.w3-margin.w3-white
            .w3-container
              h3
                p(id="nomePerfil")
              h5
                p(id="emailPerfil")
      
      h4.w3-margin(id="titComentarios" style="display:none") Comentários

  script.
    $(document).ready(function () {
      function showTabFeed() {
        $('#publicacoesInsertZone').empty();
        $.ajax({
            url: "/feed"
        })
        .done(function( data ) {
          $('#gruposLayout').hide();
          $('#grupoLayout').hide();
          $('#publicacoesLayout').show();
          $('#perfilLayout').hide();
          $('#tabGrupos').removeClass('active');
          $('#tabFeed').addClass('active');
          $('#tabPerfil').removeClass('active');
          data.forEach(function(item){
            $("#divComentarioForm").attr("style", "")
            var Clone = $('#templatePublicacoes #idk #t').clone(true);
            var pubClone = $('#pub').clone(true);
            console.log(item)
            Clone.attr("style", "");
            pubClone.attr("style", "");
            if(item.conteudo == '') {
              pubClone.find('#conteudoPub').text("Publicação sem mensagem");
            } else 
              pubClone.find('#conteudoPub').text(item.conteudo);
            if (item.metadata == '') {
              pubClone.find('#metadataPub').text("Publicação sem tags");
            } else
              pubClone.find('#metadataPub').text("Tags: "+ item.metadata);
            pubClone.find('#dataPub').text(item.data);
            pubClone.find('#idPub').text(item._id);

            pubClone.appendTo(Clone)

            if(item.comentarios.length > 0) {
              $("#titComentarios").attr("style", "")
              $("#titComentarios").appendTo(Clone)
              item.comentarios.forEach(function(itemc){
                var comClone = $('#templateComentarios').clone(true);
                console.log("Entrei")
                comClone.attr("style", "");
                comClone.find('#conteudoCom').text(itemc.conteudo);
                comClone.find('#utilizadorCom').text("Comentado por: " + itemc.utilizador + " Buscar o nome?");
                comClone.find('#dataCom').text(itemc.data);
                comClone.find('#idCom').text(itemc._id);
                comClone.find('#idPub').text(item._id);
                comClone.appendTo(Clone);
              })
            }
            $("#divComentarioForm #comentarioForm #pubidForm").val(item._id);
            $("#divComentarioForm").appendTo(Clone)
            Clone.appendTo("#publicacoesInsertZone");
          })
        });
      }
      showTabFeed();
      $("#tabFeed").on("click", function () {
        if(!$('#tabFeed').hasClass('active')){
          showTabFeed();
        }
      });
      $("#tabGrupos").on("click", function () {
        if(!$('#tabGrupos').hasClass('active')){
          $('#gruposInsertZone').empty();
          $.ajax({
              url: "/grupos"
          })
          .done(function( data ) {
            $('#publicacoesLayout').hide();
            $('#gruposLayout').show();
            $('#grupoLayout').hide();
            $('#perfilLayout').hide();
            $('#tabFeed').removeClass('active');
            $('#tabGrupos').addClass('active');
            $('#tabPerfil').removeClass('active');
            data.forEach(function(item){
              var clone = $('#templateGrupos').clone(true);
              clone.attr("style", "");
              clone.find(".grupo-container").attr('id', item._id);
              clone.find('#nomeGrupo').text(item.nome);
              clone.find('#descricaoGrupo').text(item.descricao);
              clone.find('#adminGrupo').text(item.admin);
              clone.find('#membrosGrupo').text(item.membros.length);
              clone.appendTo("#gruposInsertZone");
            })
          });
        }
      });
      $("#tabPerfil").on("click", function () {
        if(!$('#tabPerfil').hasClass('active')){
          $('#perfilInsertZone').empty();
          $.ajax({
              url: "/perfil"
          })
          .done(function( data ) {
            $('#publicacoesLayout').hide();
            $('#gruposLayout').hide();
            $('#grupoLayout').hide();
            $('#perfilLayout').show();
            $('#tabFeed').removeClass('active');
            $('#tabGrupos').removeClass('active');
            $('#tabPerfil').addClass('active');
            var clone = $('#templatePerfil').clone(true);
            clone.attr("style", "");
            clone.find('#nomePerfil').text(data.nome);
            clone.find('#emailPerfil').text(data.email);
            clone.appendTo("#perfilInsertZone");
          });
        }
      });
    });
